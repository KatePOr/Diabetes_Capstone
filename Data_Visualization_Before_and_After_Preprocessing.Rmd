---
title: "Data Visualization for Preprocessing"
author: "Kate O'Rourke"
date: "2024-11-19"
output: pdf_document
---
```{r}
library(tidyverse)
library(haven)
library(ggplot2)
library(dplyr)
library(caret) # used to split dataset
library(readr)
```

# Read in .XPT data file - KO
```{r}
CDC_2023 <- read_xpt('LLCP2023.XPT')
```

# Remove unused columns - KO
```{r}
CDC_2023_subset = subset(CDC_2023, 
                         select = c(EDUCA, EMPLOY1, INCOME3, WEIGHT2, HEIGHT3, SEXVAR, PHYSHLTH, MENTHLTH, PERSDOC3,
                                               MEDCOST1, SMOKE100, DRNK3GE5, EXERANY2, BPHIGH6, TOLDHI3, CVDINFR4,
                                               CVDCRHD4, CVDSTRK3, CHCKDNY2, DIABETE4, DIABTYPE, `_AGE80`)
                         )
```

#Calculate BMI

## Filter out rows with metric measurements (e.g., codes like 9061-9998 for metric values) - SG
```{r}
CDC_2023_subset <- CDC_2023_subset %>%
  filter(
    !(HEIGHT3 >= 9000),
    !(WEIGHT2 >=9000),
    WEIGHT2 != 7777,       # Filter out any values where person refused or didn't know weight
    HEIGHT3 != 7777
    )

# Extract feet and inches assuming HEIGHT3 values are in a format like '511' (5 feet, 11 inches)
CDC_2023_subset <- CDC_2023_subset %>%
  mutate(
    feet = as.numeric(substr(HEIGHT3, 1, 1)),  # Extract first digit as feet
    inches = as.numeric(substr(HEIGHT3, 2, 3)),  # Extract next two as inches
    height_inches = feet * 12 + inches  # Convert total height to inches
  ) %>%
  select(-feet, -inches) 
```

## Calculate BMI and add it as a new column - SG
```{r}
CDC_2023_subset <- CDC_2023_subset %>%
  mutate(BMI = (WEIGHT2 * 703) / (height_inches^2))
```

# PreCleaning Visualization of BMI -KO
```{r}
ggplot() +
  geom_density(aes(BMI), data = CDC_2023_subset) +
  ylab("Density") +
  theme_bw() +
  ggtitle("Before Preprocessing") 
```

# PreCleaning Visualization of EDUCA -KO
```{r}
CDC_2023_subset %>%
  filter(EDUCA != 9) %>%             # Refused education level
  ggplot() +
    geom_bar(aes(EDUCA), data = CDC_2023_subset) +
    scale_x_continuous(limits=c(0, 7), breaks = c(1,2,3,4,5,6)) +
    xlab("Education Level") +
    ylab("Count") +
    theme_bw() +
    ggtitle("Before Preprocessing and Cleaning") 
```

# PreCleaning Visualization of Employment Status -KO
```{r}
CDC_2023_subset$EMPLOY1 <- replace(CDC_2023_subset$EMPLOY1, CDC_2023_subset$EMPLOY1 == 1 | CDC_2023_subset$EMPLOY1 == 2, 1) 
CDC_2023_subset$EMPLOY1 <- replace(CDC_2023_subset$EMPLOY1, CDC_2023_subset$EMPLOY1 == 5 | CDC_2023_subset$EMPLOY1 == 6 | CDC_2023_subset$EMPLOY1 == 7, 2) 
CDC_2023_subset$EMPLOY1 <- replace(CDC_2023_subset$EMPLOY1, CDC_2023_subset$EMPLOY1 == 3 | CDC_2023_subset$EMPLOY1 == 4 | CDC_2023_subset$EMPLOY1 == 8, 3) 
CDC_2023_subset %>%
  filter(EMPLOY1 != 9) %>%           # Refused employment status
  ggplot() +
    geom_bar(aes(EMPLOY1), data = CDC_2023_subset) +
    scale_x_continuous(limits=c(0, 4), breaks = c(1,2,3)) +
    xlab("Employment Level") +
    ylab("Count") +
    theme_bw() +
    ggtitle("Before Preprocessing and Cleaning")  
```

# PreCleaning Visualization of Income -KO
```{r}
CDC_2023_subset %>%
  filter(INCOME3 != 77 & INCOME3 != 99) %>%    # Don't know or refused income level
  ggplot() +
    geom_bar(aes(INCOME3), data = CDC_2023_subset) +
    scale_x_continuous(limits=c(0, 12), breaks = c(1,2,3,4,5,6,7,8,9,10,11)) +
    xlab("Income Level") +
    ylab("Count") +
    theme_bw() +
    ggtitle("Before Preprocessing and Cleaning") 
```

# After Processing
## Read in dataset - KO
```{r}
CDC_2023_subset <- read_csv("CDC_2023_cleaned.csv")
```

## Remove unused columns - KO
```{r}
CDC_2023_subset <-  subset(CDC_2023_subset, select = -c(1, 5:6, 22, 24) )
```

## Convert columns (except for EDUCA, EMPLOY1, INCOME3, PHYSHLTH, MENTHLTH, DRNK3GE5, _AGE80, BMI) to factors - KO
```{r}
col_names <- colnames(CDC_2023_subset)
col_names <- col_names[-c(1:3, 5:6, 10, 19, 20)] # Column 1 (EDUCA), 2 (EMPLOY1), 3 (INCOME3), 5 (PHYSHLTH), 6 (MENTHLTH), 10 (DRNK3GE5), 19 (_AGE80), 20 (BMI)
CDC_2023_subset[,col_names] <- lapply(CDC_2023_subset[,col_names] , factor)
```

## Split dataset into training and test sets - KO
```{r}
training <- createDataPartition(CDC_2023_subset$DIABETE4,
                                         p = 0.77,
                                         list = FALSE,
                                         times = 1)

CDC_2023_training <- CDC_2023_subset[training, ]
CDC_2023_test <- CDC_2023_subset[-training, ]
```

## Function to normalize BMI column - KO
```{r}
# Function to normalize specific columns based on dataset and columns specified
normalize <- function(dataset, columns) {
  scale(dataset[, columns],
  center = apply(dataset[, columns], 2, mean),
  scale = apply(dataset[, columns], 2, sd)
  )
}
```

## Normalize Numeric Columns in training and test sets - KO
```{r}
columns = c(1:3, 5:6, 10, 19, 20)
CDC_2023_training[, columns] <- normalize(CDC_2023_training, columns)
CDC_2023_test[, columns] <- normalize(CDC_2023_test, columns)
```

# PostCleaning Visualization of BMI -KO
```{r}
ggplot() +
  geom_density(aes(BMI, fill = "Training_Data"), alpha = .2, data = CDC_2023_training) +
  geom_density(aes(BMI, fill = "Test_Data"), alpha = .2, data = CDC_2023_test) +
  scale_fill_manual(name = "Dataset", values = c(Training_Data = "red", Test_Data = "green")) +
  ggtitle("After Preprocessing and Splitting") 
```

# PostCleaning Visualization of Education -KO
```{r}
ggplot() +
  geom_bar(aes(EDUCA, fill = "Training_Data"), alpha = .5, data = CDC_2023_training) +
  geom_bar(aes(EDUCA, fill = "Test_Data"), alpha = .5, data = CDC_2023_test) +
  scale_fill_manual(name = "Dataset", values = c(Training_Data = "red", Test_Data = "green")) +
  xlab("Education Level") +
  ggtitle("After Preprocessing and Splitting")
```

# PostCleaning Visualization of Employment Status -KO
```{r}
ggplot() +
  geom_bar(aes(EMPLOY1, fill = "Training_Data"), alpha = .5, data = CDC_2023_training) +
  geom_bar(aes(EMPLOY1, fill = "Test_Data"), alpha = .5, data = CDC_2023_test) +
  scale_fill_manual(name = "Dataset", values = c(Training_Data = "red", Test_Data = "green")) +
  xlab("Employment Level") +
  ggtitle("After Preprocessing and Splitting")
```

# PostCleaning Visualization of Income -KO
```{r}
ggplot() +
  geom_bar(aes(INCOME3, fill = "Training_Data"), alpha = .5, data = CDC_2023_training) +
  geom_bar(aes(INCOME3, fill = "Test_Data"), alpha = .5, data = CDC_2023_test) +
  scale_fill_manual(name = "Dataset", values = c(Training_Data = "red", Test_Data = "green")) +
  xlab("Income Level") +
  ggtitle("After Preprocessing and Splitting")
```

